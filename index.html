<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Popup Auth Comments</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">

<div class="max-w-3xl mx-auto p-6">
  <!-- Auth Controls -->
  <div id="auth" class="mb-6">
    <p id="user-info" class="mb-2 text-sm text-gray-700">Checking auth‚Ä¶</p>
    <div class="flex gap-2 flex-wrap">
      <button id="login-main-btn" class="auth-show px-4 py-2 bg-green-600 text-white rounded">Login</button>
      <button id="register-main-btn" class="auth-show px-4 py-2 bg-yellow-600 text-white rounded">Register</button>
      <button id="logout-btn" class="auth-hide hidden px-4 py-2 bg-red-600 text-white rounded">Logout</button>
    </div>
  </div>

  <!-- New Comment -->
  <div class="mb-6">
    <textarea id="new-comment" rows="3" placeholder="Add a public comment..."
              class="w-full p-3 border rounded"></textarea>
    <button id="post-comment-btn" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded">
      Post Comment
    </button>
  </div>

  <!-- Comments List -->
  <div id="comments" class="space-y-4"></div>
  <button id="load-more-btn" class="mt-4 px-4 py-2 bg-gray-300 text-gray-700 rounded hidden">
    Load More Comments
  </button>
</div>

<!-- Login Modal -->
<div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-80">
    <h2 class="text-lg font-semibold mb-4">Login Options</h2>
    <input id="login-email" type="email" placeholder="Email" class="mb-2 w-full border p-2 rounded" />
    <input id="login-pass" type="password" placeholder="Password" class="mb-4 w-full border p-2 rounded" />
    <button id="login-email-btn" class="w-full mb-2 px-4 py-2 bg-green-600 text-white rounded">Email/Password</button>
    <button id="login-google-btn" class="w-full mb-2 px-4 py-2 bg-blue-600 text-white rounded">Google</button>
    <button onclick="closeModal('login-modal')" class="w-full px-4 py-2 bg-gray-400 text-white rounded">Close</button>
  </div>
</div>

<!-- Register Modal -->
<div id="register-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-80">
    <h2 class="text-lg font-semibold mb-4">Register Options</h2>
    <input id="reg-email" type="email" placeholder="Email" class="mb-2 w-full border p-2 rounded" />
    <input id="reg-pass" type="password" placeholder="Password" class="mb-4 w-full border p-2 rounded" />
    <button id="register-email-btn" class="w-full mb-2 px-4 py-2 bg-green-600 text-white rounded">Email/Password</button>
    <button id="register-google-btn" class="w-full mb-2 px-4 py-2 bg-blue-600 text-white rounded">Google</button>
    <button id="register-guest-btn" class="w-full mb-2 px-4 py-2 bg-gray-600 text-white rounded">Guest</button>
    <button onclick="closeModal('register-modal')" class="w-full px-4 py-2 bg-gray-400 text-white rounded">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth, GoogleAuthProvider,
  onAuthStateChanged, signInWithPopup,
  signInAnonymously, createUserWithEmailAndPassword,
  signInWithEmailAndPassword, signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, collection, doc,
  addDoc, updateDoc, deleteDoc,
  serverTimestamp, query, orderBy,
  limit, startAfter, getDocs, onSnapshot,
  arrayUnion, arrayRemove, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// --- CONFIG & INIT ---
const firebaseConfig = {
  apiKey: "AIzaSyCAVF_QueVUEGojKuB3vKH8L39wMZocJ24",
  authDomain: "ishwar0980-7525b.firebaseapp.com",
  projectId: "ishwar0980-7525b",
  storageBucket: "ishwar0980-7525b.appspot.com",
  messagingSenderId: "522376702284",
  appId: "1:522376702284:web:433b482f1196c9c23d87e9"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const googleProvider = new GoogleAuthProvider();

// --- DOM ---
const loginMainBtn = document.getElementById("login-main-btn");
const registerMainBtn = document.getElementById("register-main-btn");
const logoutBtn = document.getElementById("logout-btn");
const userInfo = document.getElementById("user-info");
const newCommentEl = document.getElementById("new-comment");
const postCommentBtn = document.getElementById("post-comment-btn");
const commentsContainer = document.getElementById("comments");
const loadMoreBtn = document.getElementById("load-more-btn");
let currentUser = null;
let lastVisible = null;
const PAGE_SIZE = 10;

// --- Modal Helpers ---
window.closeModal = function(id) {
  document.getElementById(id).classList.add("hidden");
}
function openModal(id) {
  document.getElementById(id).classList.remove("hidden");
}

// --- Auth Handlers ---
loginMainBtn.onclick = () => openModal('login-modal');
registerMainBtn.onclick = () => openModal('register-modal');

// Login options
const loginEmailBtn = document.getElementById('login-email-btn');
const loginGoogleBtn = document.getElementById('login-google-btn');
const loginEmailInput = document.getElementById('login-email');
const loginPassInput = document.getElementById('login-pass');
loginEmailBtn.onclick = () => signInWithEmailAndPassword(auth, loginEmailInput.value, loginPassInput.value).catch(e=>alert(e.message));
loginGoogleBtn.onclick = () => signInWithPopup(auth, googleProvider).catch(e=>alert(e.message));

// Register options
const registerEmailBtn = document.getElementById('register-email-btn');
const registerGoogleBtn = document.getElementById('register-google-btn');
const registerGuestBtn = document.getElementById('register-guest-btn');
const regEmailInput = document.getElementById('reg-email');
const regPassInput = document.getElementById('reg-pass');
registerEmailBtn.onclick = () => createUserWithEmailAndPassword(auth, regEmailInput.value, regPassInput.value).catch(e=>alert(e.message));
registerGoogleBtn.onclick = () => signInWithPopup(auth, googleProvider).catch(e=>alert(e.message));
registerGuestBtn.onclick = () => signInAnonymously(auth).catch(e=>alert(e.message));

logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, user => {
  currentUser = user;
  if (user) {
    userInfo.textContent = `Hello, ${user.displayName||'Guest'}`;
    document.querySelectorAll('.auth-show').forEach(el=>el.classList.add('hidden'));
    document.querySelectorAll('.auth-hide').forEach(el=>el.classList.remove('hidden'));
    closeModal('login-modal');
    closeModal('register-modal');
  } else {
    userInfo.textContent = 'Not signed in';
    document.querySelectorAll('.auth-show').forEach(el=>el.classList.remove('hidden'));
    document.querySelectorAll('.auth-hide').forEach(el=>el.classList.add('hidden'));
  }
});

// --- Utilities ---
function timeAgo(ts) {
  const now = Date.now();
  const seconds = Math.floor((now - ts.toMillis())/1000);
  if (seconds < 60) return `${seconds}s ago`;
  const mins = Math.floor(seconds/60);
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins/60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs/24);
  return `${days}d ago`;
}

// --- Comment CRUD & UI ---
postCommentBtn.onclick = async () => {
  if (!currentUser) return alert('Please login first');
  const text = newCommentEl.value.trim(); if (!text) return;
  await addDoc(collection(db,'comments'),{
    text, uid: currentUser.uid,
    name: currentUser.displayName||'Guest',
    created: serverTimestamp(), edited:false, likes:[], dislikes:[]
  });
  newCommentEl.value=''; loadComments(true);
};

async function loadComments(reset=false) {
  if (reset) { commentsContainer.innerHTML=''; lastVisible=null; }
  let q = query(collection(db,'comments'), orderBy('created','desc'), limit(PAGE_SIZE));
  if (lastVisible) q = query(q, startAfter(lastVisible));
  const snap = await getDocs(q);
  loadMoreBtn.classList.toggle('hidden', snap.size < PAGE_SIZE);
  lastVisible = snap.docs[snap.docs.length-1];
  snap.forEach(docSnap=> renderComment(docSnap.id, docSnap.data()));
}
loadMoreBtn.onclick = () => loadComments();

function renderComment(id,data) {
  const div = document.createElement('div');
  div.className='bg-white p-4 rounded shadow-sm';
  const isOwner = currentUser && currentUser.uid===data.uid;
  div.innerHTML = `
    <div class="flex justify-between">
      <p class="font-semibold">${data.name}</p>
      <p class="text-xs text-gray-500">${data.created?timeAgo(data.created):''}${data.edited?' ‚Ä¢ edited':''}</p>
    </div>
    <p class="my-2" id="text-${id}">${data.text}</p>
    <div class="flex gap-2 text-sm text-gray-600">
      <button onclick="likeComment('${id}')">üëç ${data.likes.length}</button>
      <button onclick="dislikeComment('${id}')">üëé ${data.dislikes.length}</button>
      <button onclick="replyComment('${id}','${data.name}')">Reply</button>
      ${isOwner? `<button onclick="editComment('${id}', \`${data.text}\`)" class="text-blue-500">Edit</button>
      <button onclick="deleteComment('${id}')" class="text-red-500">Delete</button>`: ''}
    </div>
    <div class="ml-6 mt-2 reply-form hidden" id="reply-form-${id}">
      <textarea rows="2" class="w-full border rounded p-2" placeholder="Write a reply..."></textarea>
      <button class="mt-1 px-3 py-1 bg-indigo-500 text-white rounded" onclick="postReply('${id}')">Reply</button>
    </div>
    <div class="ml-6 mt-2" id="replies-${id}"></div>
  `;
  commentsContainer.appendChild(div);
  loadReplies(id);
}

window.likeComment = async id => {
  if (!currentUser) return alert('Login first');
  const ref = doc(db,'comments',id);
  const snap = await getDoc(ref);
  const likes = snap.data().likes||[];
  const dislikes = snap.data().dislikes||[];
  await updateDoc(ref,{
    likes: likes.includes(currentUser.uid)? arrayRemove(currentUser.uid): arrayUnion(currentUser.uid),
    dislikes: arrayRemove(currentUser.uid)
  });
  loadComments(true);
};

window.dislikeComment = async id => {
  if (!currentUser) return alert('Login first');
  const ref = doc(db,'comments',id);
  const snap = await getDoc(ref);
  const dislikes = snap.data().dislikes||[];
  await updateDoc(ref,{
    dislikes: dislikes.includes(currentUser.uid)? arrayRemove(currentUser.uid): arrayUnion(currentUser.uid),
    likes: arrayRemove(currentUser.uid)
  });
  loadComments(true);
};

window.editComment = async (id,oldText) => {
  const newText = prompt('Edit your comment:',oldText);
  if (!newText) return;
  await updateDoc(doc(db,'comments',id),{ text:newText, edited:true });
  loadComments(true);
};

window.deleteComment = async id => {
  if (!confirm('Delete this comment?')) return;
  await deleteDoc(doc(db,'comments',id));
  loadComments(true);
};

window.replyComment = id => {
  document.getElementById(`reply-form-${id}`).classList.toggle('hidden');
};

window.postReply = async id => {
  const container = document.getElementById(`reply-form-${id}`);
  const ta = container.querySelector('textarea');
  const txt = ta.value.trim();
  if (!txt) return;
  await addDoc(collection(db,'comments',id,'replies'),{
    text:txt, uid:currentUser.uid, name:currentUser.displayName||'Guest', created:serverTimestamp()
  });
  ta.value='';
  container.classList.add('hidden');
  loadReplies(id);
};

async function loadReplies(commentId) {
  const cont = document.getElementById(`replies-${commentId}`);
  cont.innerHTML='';
  const snap = await getDocs(query(collection(db,'comments',commentId,'replies'),orderBy('created','asc')));
  snap.forEach(rsnap => {
    const d = rsnap.data();
    const el = document.createElement('div');
    el.className='bg-gray-50 p-2 rounded mb-1';
    el.innerHTML = `
      <div class=\"flex justify-between\">
        <p class=\"text-sm\"><strong>${d.name}</strong></p>
        <p class=\"text-xs text-gray-500\">${d.created?timeAgo(d.created):''}</p>
      </div>
      <p class=\"text-sm ml-2\">${d.text}</p>
    `;
    cont.appendChild(el);
  });
}

onSnapshot(query(collection(db,'comments'),orderBy('created','desc'),limit(PAGE_SIZE)),()=>{
  loadComments(true);
});

// Initial load
loadComments();
</script>
</body>
</html>
