<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comments System</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-3xl mx-auto p-6">
    <!-- Auth UI -->
    <div id="auth" class="mb-6">
      <p id="user-info" class="mb-2 text-sm text-gray-700">Checking authâ€¦</p>
      <div class="flex gap-2 flex-wrap">
        <button id="login-main-btn" class="auth-show px-4 py-2 bg-green-600 text-white rounded">Login</button>
        <button id="register-main-btn" class="auth-show px-4 py-2 bg-yellow-600 text-white rounded">Register</button>
        <button id="logout-btn" class="auth-hide hidden px-4 py-2 bg-red-600 text-white rounded">Logout</button>
      </div>
    </div>

    <!-- New Comment -->
    <div class="mb-6">
      <textarea id="new-comment" rows="3" placeholder="Add a public comment..." class="w-full p-3 border rounded"></textarea>
      <button id="post-comment-btn" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded">Post Comment</button>
    </div>

    <!-- Comments -->
    <div id="comments" class="space-y-4"></div>
    <button id="load-more-btn" class="mt-4 px-4 py-2 bg-gray-300 text-gray-700 rounded hidden">
      Load More Comments
    </button>
  </div>

  <!-- Login Modal -->
  <div id="login-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded max-w-sm w-full space-y-4">
      <h2 class="text-xl font-semibold">Login</h2>
      <input id="login-email" type="email" placeholder="Email" class="w-full p-2 border rounded" />
      <input id="login-pass" type="password" placeholder="Password" class="w-full p-2 border rounded" />
      <button id="login-email-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded">Login with Email</button>
      <button id="login-google-btn" class="w-full px-4 py-2 bg-red-600 text-white rounded">Login with Google</button>
      <button onclick="closeModal('login-modal')" class="mt-2 text-sm text-gray-600">Cancel</button>
    </div>
  </div>

  <!-- Register Modal -->
  <div id="register-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded max-w-sm w-full space-y-4">
      <h2 class="text-xl font-semibold">Register</h2>
      <input id="reg-email" type="email" placeholder="Email" class="w-full p-2 border rounded" />
      <input id="reg-pass" type="password" placeholder="Password" class="w-full p-2 border rounded" />
      <button id="register-email-btn" class="w-full px-4 py-2 bg-yellow-600 text-white rounded">Register with Email</button>
      <button id="register-google-btn" class="w-full px-4 py-2 bg-red-600 text-white rounded">Register with Google</button>
      <button id="register-guest-btn" class="w-full px-4 py-2 bg-gray-600 text-white rounded">Continue as Guest</button>
      <button onclick="closeModal('register-modal')" class="mt-2 text-sm text-gray-600">Cancel</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, onAuthStateChanged,
      signInWithPopup, signInAnonymously,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, doc,
      addDoc, updateDoc, deleteDoc,
      serverTimestamp, query, orderBy,
      limit, startAfter, getDocs, onSnapshot,
      arrayUnion, arrayRemove, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCAVF_QueVUEGojKuB3vKH8L39wMZocJ24",
      authDomain: "ishwar0980-7525b.firebaseapp.com",
      projectId: "ishwar0980-7525b",
      storageBucket: "ishwar0980-7525b.appspot.com",
      messagingSenderId: "522376702284",
      appId: "1:522376702284:web:433b482f1196c9c23d87e9"
    };
    const OWNER_UID = "LMRHGwdCUeRRJRQnOyPNFwDMtK92";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const gp = new GoogleAuthProvider();

    // Elements
    const loginBtn = document.getElementById("login-main-btn"),
          registerBtn = document.getElementById("register-main-btn"),
          logoutBtn = document.getElementById("logout-btn"),
          userInfo = document.getElementById("user-info"),
          newCommentEl = document.getElementById("new-comment"),
          postCommentBtn = document.getElementById("post-comment-btn"),
          commentsDiv = document.getElementById("comments"),
          loadMoreBtn = document.getElementById("load-more-btn");

    window.closeModal = id => document.getElementById(id).classList.add("hidden");
    const openModal = id => document.getElementById(id).classList.remove("hidden");

    // Auth button handlers
    loginBtn.onclick = () => openModal("login-modal");
    registerBtn.onclick = () => openModal("register-modal");
    logoutBtn.onclick = () => signOut(auth);

    document.getElementById("login-email-btn").onclick = async () => {
      try {
        await signInWithEmailAndPassword(auth, document.getElementById("login-email").value, document.getElementById("login-pass").value);
        closeModal("login-modal");
      } catch(e) { alert(e.message); }
    };

    document.getElementById("login-google-btn").onclick = async () => {
      try {
        await signInWithPopup(auth, gp);
        closeModal("login-modal");
      } catch(e) { alert(e.message); }
    };

    document.getElementById("register-email-btn").onclick = async () => {
      try {
        await createUserWithEmailAndPassword(auth, document.getElementById("reg-email").value, document.getElementById("reg-pass").value);
        closeModal("register-modal");
      } catch(e) { alert(e.message); }
    };

    document.getElementById("register-google-btn").onclick = async () => {
      try {
        await signInWithPopup(auth, gp);
        closeModal("register-modal");
      } catch(e) { alert(e.message); }
    };

    document.getElementById("register-guest-btn").onclick = async () => {
      try {
        await signInAnonymously(auth);
        closeModal("register-modal");
      } catch(e) { alert(e.message); }
    };

    let currentUser = null, lastVisible = null;
    const PAGE_SIZE = 10;

    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        userInfo.textContent = `Hello, ${user.displayName || "Guest"}`;
        document.querySelectorAll(".auth-show").forEach(el => el.classList.add("hidden"));
        document.querySelectorAll(".auth-hide").forEach(el => el.classList.remove("hidden"));
      } else {
        userInfo.textContent = "Not signed in";
        document.querySelectorAll(".auth-show").forEach(el => el.classList.remove("hidden"));
        document.querySelectorAll(".auth-hide").forEach(el => el.classList.add("hidden"));
      }
      loadComments(true); // Refresh comments on auth change
    });

    function timeAgo(ts) {
      const now = Date.now(), secs = Math.floor((now - ts.toMillis()) / 1000);
      if (secs < 60) return `${secs}s ago`;
      const m = Math.floor(secs / 60); if (m < 60) return `${m}m ago`;
      const h = Math.floor(m / 60); if (h < 24) return `${h}h ago`;
      const d = Math.floor(h / 24); return `${d}d ago`;
    }

    async function loadComments(isNew) {
      let q = query(collection(db, "comments"), orderBy("createdAt", "desc"), limit(PAGE_SIZE));
      if (!isNew && lastVisible) {
        q = query(collection(db, "comments"), orderBy("createdAt", "desc"), startAfter(lastVisible), limit(PAGE_SIZE));
      }

      const querySnapshot = await getDocs(q);
      lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];

      if (querySnapshot.empty) {
        loadMoreBtn.classList.add("hidden");
      } else {
        loadMoreBtn.classList.remove("hidden");
      }

      querySnapshot.forEach(doc => {
        const comment = doc.data();
        const commentId = doc.id;
        const commentEl = document.createElement("div");
        commentEl.className = "p-4 bg-white rounded-lg shadow-md space-y-2";

        commentEl.innerHTML = `
          <div class="flex items-center justify-between">
            <span class="text-sm text-gray-500">${comment.owner ? "You" : comment.ownerName}</span>
            <span class="text-xs text-gray-400">${timeAgo(comment.createdAt)}</span>
          </div>
          <div class="text-lg">${comment.text}</div>
          <div class="flex gap-2">
            <button class="text-sm text-blue-500 like-btn" data-id="${commentId}">Like</button>
            <button class="text-sm text-red-500 dislike-btn" data-id="${commentId}">Dislike</button>
            ${currentUser && currentUser.uid === comment.ownerId ? `
            <button class="text-sm text-yellow-500 edit-btn" data-id="${commentId}">Edit</button>
            <button class="text-sm text-gray-500 delete-btn" data-id="${commentId}">Delete</button>` : ''}
          </div>
        `;

        commentsDiv.appendChild(commentEl);

        // Edit Button
        const editBtn = commentEl.querySelector(".edit-btn");
        if (editBtn) {
          editBtn.onclick = async () => {
            const newText = prompt("Edit your comment", comment.text);
            if (newText) {
              await updateDoc(doc(db, "comments", commentId), { text: newText });
            }
          };
        }

        // Delete Button
        const deleteBtn = commentEl.querySelector(".delete-btn");
        if (deleteBtn) {
          deleteBtn.onclick = async () => {
            if (confirm("Are you sure you want to delete this comment?")) {
              await deleteDoc(doc(db, "comments", commentId));
            }
          };
        }

        // Like Button
        const likeBtn = commentEl.querySelector(".like-btn");
        likeBtn.onclick = async () => {
          await updateDoc(doc(db, "comments", commentId), {
            likes: arrayUnion(currentUser.uid)
          });
        };

        // Dislike Button
        const dislikeBtn = commentEl.querySelector(".dislike-btn");
        dislikeBtn.onclick = async () => {
          await updateDoc(doc(db, "comments", commentId), {
            dislikes: arrayUnion(currentUser.uid)
          });
        };
      });
    }

    postCommentBtn.onclick = async () => {
      const newText = newCommentEl.value;
      if (newText.trim()) {
        await addDoc(collection(db, "comments"), {
          text: newText,
          ownerId: currentUser.uid,
          ownerName: currentUser.displayName || "Anonymous",
          createdAt: serverTimestamp(),
          likes: [],
          dislikes: []
        });
        newCommentEl.value = "";
        loadComments(true);
      }
    };

    loadMoreBtn.onclick = () => loadComments(false);
  </script>
</body>
</html>
