<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Firebase Comment System</title>
  <!-- Tailwind CSS via Play CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <!-- Firebase SDKs: App, Auth, Firestore (using compat libraries) -->
  <script src="https://www.gstatic.com/firebasejs/12.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.5.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">

  <h1 class="text-2xl font-bold mb-4">Comments Section</h1>

  <!-- Authentication Section -->
  <div id="auth-section" class="mb-6">
    <button id="google-login" class="mr-2 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded">Sign in with Google</button>
    <button id="anon-login" class="mr-2 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded">Continue as Guest</button>
    <div id="email-auth" class="inline-block mr-2">
      <input id="email" type="email" placeholder="Email" class="border px-2 py-1 mr-2 rounded" />
      <input id="password" type="password" placeholder="Password" class="border px-2 py-1 mr-2 rounded" />
      <button id="email-register" class="mr-1 bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded">Register</button>
      <button id="email-login" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded">Login</button>
    </div>
    <button id="signout" class="bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded hidden">Sign Out</button>
  </div>

  <!-- Comment Form (hidden until signed-in) -->
  <div id="comment-section" class="mb-4 hidden">
    <textarea id="comment-text" rows="3" placeholder="Write a comment..." class="w-full border px-3 py-2 mb-2 rounded"></textarea>
    <button id="submit-comment" class="bg-blue-700 hover:bg-blue-800 text-white py-2 px-4 rounded">Post Comment</button>
  </div>

  <!-- Comments List -->
  <div id="comments-container" class="space-y-4"></div>

  <!-- Load More Button -->
  <button id="load-more" class="mt-4 bg-gray-700 hover:bg-gray-800 text-white py-2 px-4 rounded hidden">Load More Comments</button>

  <script>
    // Firebase configuration (replace with your project settings)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      // ... other config values ...
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Admin/Owner UID for highlighting
    const OWNER_UID = 'LMRHGwdCUeRRJRQnOyPNFwDMtK92';

    // Get UI elements
    const googleBtn = document.getElementById('google-login');
    const anonBtn = document.getElementById('anon-login');
    const emailRegisterBtn = document.getElementById('email-register');
    const emailLoginBtn = document.getElementById('email-login');
    const signoutBtn = document.getElementById('signout');
    const commentSection = document.getElementById('comment-section');
    const commentInput = document.getElementById('comment-text');
    const submitCommentBtn = document.getElementById('submit-comment');
    const commentsContainer = document.getElementById('comments-container');
    const loadMoreBtn = document.getElementById('load-more');

    // Authentication state observer
    auth.onAuthStateChanged((user) => {
      if (user) {
        // User is signed in.
        // Hide login UI, show comment form and sign-out button.
        googleBtn.style.display = 'none';
        anonBtn.style.display = 'none';
        document.getElementById('email-auth').style.display = 'none';
        signoutBtn.style.display = 'inline-block';
        commentSection.classList.remove('hidden');
        // Load comments
        loadComments();
      } else {
        // User is signed out.
        googleBtn.style.display = 'inline-block';
        anonBtn.style.display = 'inline-block';
        document.getElementById('email-auth').style.display = 'inline-block';
        signoutBtn.style.display = 'none';
        commentSection.classList.add('hidden');
        commentsContainer.innerHTML = '';
        loadMoreBtn.classList.add('hidden');
        lastVisible = null;
      }
    });

    // Google sign-in
    googleBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider).catch(console.error);
    };

    // Anonymous sign-in
    anonBtn.onclick = () => {
      firebase.auth().signInAnonymously().catch(console.error);
    };

    // Email/Password registration
    emailRegisterBtn.onclick = () => {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      auth.createUserWithEmailAndPassword(email, pass)
        .catch(error => { console.error(error.code, error.message); });
    };

    // Email/Password login
    emailLoginBtn.onclick = () => {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, pass)
        .catch(error => { console.error(error.code, error.message); });
    };

    // Sign out
    signoutBtn.onclick = () => {
      auth.signOut().catch(console.error);
    };

    // Comment posting
    submitCommentBtn.onclick = () => {
      const text = commentInput.value.trim();
      const user = auth.currentUser;
      if (!text || !user) return;
      db.collection("comments").add({
        uid: user.uid,
        name: user.displayName || user.email || "Anonymous",
        text: text,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        commentInput.value = '';
        // Optionally prepend or refresh comments:
        commentsContainer.innerHTML = '';
        lastVisible = null;
        loadComments();
      }).catch(console.error);
    };

    // Load comments with pagination
    let lastVisible = null;
    function loadComments() {
      let query = db.collection("comments").orderBy("createdAt", "desc").limit(10);
      if (lastVisible) {
        query = query.startAfter(lastVisible);
      }
      query.get().then((snapshot) => {
        if (snapshot.empty) {
          loadMoreBtn.style.display = 'none';
          return;
        }
        // Append comments
        snapshot.docs.forEach(doc => {
          const data = doc.data();
          const commentDiv = document.createElement('div');
          commentDiv.classList.add('p-4', 'bg-white', 'rounded', 'shadow');
          if (data.uid === OWNER_UID) {
            commentDiv.classList.add('bg-yellow-100');
          }
          const author = data.name || "Anonymous";
          const text = data.text || "";
          commentDiv.innerHTML = `<p class="font-semibold">${author}:</p><p>${text}</p>`;
          commentsContainer.appendChild(commentDiv);
        });
        // Update last visible
        lastVisible = snapshot.docs[snapshot.docs.length - 1];
        // Show/hide Load More
        if (snapshot.size === 10) {
          loadMoreBtn.style.display = 'inline-block';
        } else {
          loadMoreBtn.style.display = 'none';
        }
      }).catch(console.error);
    }

    // Load more button handler
    loadMoreBtn.onclick = () => {
      loadComments();
    };
  </script>
</body>
</html>
