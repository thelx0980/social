<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Auth + Comments Demo</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-3xl mx-auto p-6">

    <!-- Auth controls -->
    <div id="auth-controls" class="mb-6 flex gap-2">
      <button id="open-login-btn" class="px-4 py-2 bg-green-600 text-white rounded">Login</button>
      <button id="open-register-btn" class="px-4 py-2 bg-yellow-500 text-white rounded">Register</button>
      <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded hidden">Logout</button>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white p-6 rounded shadow-lg w-80">
        <h2 class="text-lg mb-4">Sign In</h2>
        <button id="google-login-btn" class="w-full mb-2 px-4 py-2 bg-blue-600 text-white rounded">
          Continue with Google
        </button>
        <button id="show-email-login-btn" class="w-full mb-4 px-4 py-2 border rounded">
          Email &amp; Password
        </button>
        <div id="email-login-form" class="space-y-2 hidden">
          <input id="login-email" type="email" placeholder="Email" class="w-full px-2 py-1 border rounded" />
          <input id="login-pass"  type="password" placeholder="Password" class="w-full px-2 py-1 border rounded" />
          <button id="login-submit-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded">Login</button>
        </div>
        <button id="close-login-modal" class="mt-4 text-sm text-gray-500 hover:underline">Cancel</button>
      </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white p-6 rounded shadow-lg w-80">
        <h2 class="text-lg mb-4">Register</h2>
        <button id="google-register-btn" class="w-full mb-2 px-4 py-2 bg-blue-600 text-white rounded">
          Sign up with Google
        </button>
        <button id="show-email-register-btn" class="w-full mb-2 px-4 py-2 border rounded">
          Email &amp; Password
        </button>
        <button id="anonymous-register-btn" class="w-full mb-4 px-4 py-2 bg-gray-600 text-white rounded">
          Continue as Guest
        </button>
        <div id="email-register-form" class="space-y-2 hidden">
          <input id="reg-email" type="email" placeholder="Email" class="w-full px-2 py-1 border rounded" />
          <input id="reg-pass"  type="password" placeholder="Password" class="w-full px-2 py-1 border rounded" />
          <button id="register-submit-btn" class="w-full px-4 py-2 bg-yellow-500 text-white rounded">
            Register
          </button>
        </div>
        <button id="close-register-modal" class="mt-4 text-sm text-gray-500 hover:underline">Cancel</button>
      </div>
    </div>

    <!-- Comment box -->
    <div class="mb-6">
      <textarea id="new-comment" rows="3" placeholder="Add a public comment..." 
                class="w-full p-3 border rounded"></textarea>
      <button id="post-comment-btn" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded">
        Post Comment
      </button>
    </div>

    <!-- Comments list -->
    <div id="comments" class="space-y-4"></div>
    <button id="load-more-btn" class="mt-4 px-4 py-2 bg-gray-300 text-gray-700 rounded hidden">
      Load More Comments
    </button>
  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    // --- IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider,
      onAuthStateChanged, signInWithPopup,
      signInAnonymously, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection,
      addDoc, query, orderBy,
      limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      // …other settings…
    };

    // --- INIT ---
    initializeApp(firebaseConfig);
    const auth = getAuth();
    const db   = getFirestore();
    const googleProvider = new GoogleAuthProvider();

    // --- ELEMENTS ---
    const openLoginBtn     = document.getElementById('open-login-btn');
    const openRegisterBtn  = document.getElementById('open-register-btn');
    const logoutBtn        = document.getElementById('logout-btn');

    const loginModal       = document.getElementById('login-modal');
    const googleLoginBtn   = document.getElementById('google-login-btn');
    const showEmailLogin   = document.getElementById('show-email-login-btn');
    const emailLoginForm   = document.getElementById('email-login-form');
    const loginEmailInput  = document.getElementById('login-email');
    const loginPassInput   = document.getElementById('login-pass');
    const loginSubmitBtn   = document.getElementById('login-submit-btn');
    const closeLoginModal  = document.getElementById('close-login-modal');

    const registerModal        = document.getElementById('register-modal');
    const googleRegisterBtn    = document.getElementById('google-register-btn');
    const showEmailRegister    = document.getElementById('show-email-register-btn');
    const anonymousRegisterBtn = document.getElementById('anonymous-register-btn');
    const emailRegisterForm    = document.getElementById('email-register-form');
    const regEmailInput        = document.getElementById('reg-email');
    const regPassInput         = document.getElementById('reg-pass');
    const registerSubmitBtn    = document.getElementById('register-submit-btn');
    const closeRegisterModal   = document.getElementById('close-register-modal');

    const postCommentBtn = document.getElementById('post-comment-btn');
    const commentInput   = document.getElementById('new-comment');
    const commentsDiv    = document.getElementById('comments');
    const loadMoreBtn    = document.getElementById('load-more-btn');

    // --- HELPERS ---
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    // --- MODAL HANDLERS ---
    openLoginBtn   .addEventListener('click', () => show(loginModal));
    closeLoginModal.addEventListener('click', () => {
      hide(loginModal);
      hide(emailLoginForm);
    });
    showEmailLogin.addEventListener('click', () => {
      emailLoginForm.classList.toggle('hidden');
    });

    openRegisterBtn   .addEventListener('click', () => show(registerModal));
    closeRegisterModal.addEventListener('click', () => {
      hide(registerModal);
      hide(emailRegisterForm);
    });
    showEmailRegister.addEventListener('click', () => {
      emailRegisterForm.classList.toggle('hidden');
    });

    // --- AUTH FLOWS ---
    googleLoginBtn   .addEventListener('click', () => signInWithPopup(auth, googleProvider));
    googleRegisterBtn.addEventListener('click', () => signInWithPopup(auth, googleProvider));

    loginSubmitBtn.addEventListener('click', () => {
      signInWithEmailAndPassword(auth, loginEmailInput.value, loginPassInput.value)
        .catch(e => alert(e.message));
    });

    registerSubmitBtn.addEventListener('click', () => {
      createUserWithEmailAndPassword(auth, regEmailInput.value, regPassInput.value)
        .catch(e => alert(e.message));
    });

    anonymousRegisterBtn.addEventListener('click', () => {
      signInAnonymously(auth).catch(e => alert(e.message));
    });

    logoutBtn.addEventListener('click', () => signOut(auth));

    // --- UPDATE UI ON AUTH CHANGE ---
    onAuthStateChanged(auth, user => {
      if (user) {
        hide(openLoginBtn);
        hide(openRegisterBtn);
        show(logoutBtn);
        hide(loginModal);
        hide(registerModal);
      } else {
        show(openLoginBtn);
        show(openRegisterBtn);
        hide(logoutBtn);
      }
    });

    // --- COMMENTS LOGIC ---
    let lastVisible = null;
    const COMMENTS_BATCH = 5;

    // load initial batch
    function loadComments(initial = false) {
      let q = query(
        collection(db, 'comments'),
        orderBy('createdAt', 'desc'),
        limit(COMMENTS_BATCH)
      );
      if (!initial && lastVisible) {
        q = query(
          collection(db, 'comments'),
          orderBy('createdAt', 'desc'),
          limit(COMMENTS_BATCH),
          // startAfter(lastVisible)  // requires Firestore cursor; omitted for brevity
        );
      }
      onSnapshot(q, snapshot => {
        if (initial) commentsDiv.innerHTML = '';
        snapshot.docs.forEach(doc => {
          const data = doc.data();
          const el = document.createElement('div');
          el.className = 'p-4 bg-white rounded shadow';
          el.innerHTML = `<p class="text-sm text-gray-600">${data.author}</p>
                          <p>${data.text}</p>`;
          commentsDiv.appendChild(el);
        });
        lastVisible = snapshot.docs[snapshot.docs.length - 1];
        // if fewer than batch, hide load more
        if (snapshot.size < COMMENTS_BATCH) hide(loadMoreBtn);
        else show(loadMoreBtn);
      });
    }
    loadComments(true);
    loadMoreBtn.addEventListener('click', () => loadComments());

    postCommentBtn.addEventListener('click', async () => {
      if (!auth.currentUser) {
        alert('Please log in first!');
        return;
      }
      const text = commentInput.value.trim();
      if (!text) return;
      await addDoc(collection(db, 'comments'), {
        text,
        author: auth.currentUser.displayName || 'Anonymous',
        createdAt: new Date()
      });
      commentInput.value = '';
    });
  </script>
</body>
</html>
