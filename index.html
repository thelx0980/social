<!DOCTYPE html><html>
<head>
  <title>Advanced Comment Section</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, query, orderBy, limit, startAfter, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";const firebaseConfig = {
  apiKey: "AIzaSyCAVF_QueVUEGojKuB3vKH8L39wMZocJ24",
  authDomain: "ishwar0980-7525b.firebaseapp.com",
  projectId: "ishwar0980-7525b",
  storageBucket: "ishwar0980-7525b.appspot.com",
  messagingSenderId: "522376702284",
  appId: "1:522376702284:web:433b482f1196c9c23d87e9",
  measurementId: "G-W40FDR738Q"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let currentUser = null;
let lastVisible = null;

const OWNER_UID = "LMRHGwdCUeRRJRQnOyPNFwDMtK92";

onAuthStateChanged(auth, user => {
  currentUser = user;
  document.getElementById("user").textContent = user ? `Signed in as: ${user.displayName}` : "Not signed in";
});

window.signIn = async () => {
  try {
    await signInWithPopup(auth, provider);
  } catch (e) {
    alert("Sign-in error: " + e.message);
  }
};

window.postComment = async () => {
  const text = document.getElementById("comment").value.trim();
  if (!text || !currentUser) return alert("Sign in and write a comment first.");
  await addDoc(collection(db, "comments"), {
    text,
    name: currentUser.displayName,
    uid: currentUser.uid,
    created: serverTimestamp(),
    likes: 0,
    dislikes: 0
  });
  document.getElementById("comment").value = "";
  loadComments(true);
};

function formatTime(date) {
  const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
  if (seconds < 60) return `${seconds}s ago`;
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes}m ago`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  return `${days}d ago`;
}

window.likeComment = async (id) => {
  await updateDoc(doc(db, "comments", id), { likes: increment(1) });
  loadComments(true);
};

window.dislikeComment = async (id) => {
  await updateDoc(doc(db, "comments", id), { dislikes: increment(1) });
  loadComments(true);
};

window.deleteComment = async (id) => {
  if (currentUser?.uid === OWNER_UID) {
    await deleteDoc(doc(db, "comments", id));
    loadComments(true);
  }
};

window.loadComments = async (reset = false) => {
  const container = document.getElementById("comments");
  if (reset) {
    container.innerHTML = "";
    lastVisible = null;
  }

  let q = query(collection(db, "comments"), orderBy("created", "desc"), limit(5));
  if (lastVisible) q = query(q, startAfter(lastVisible));

  const snapshot = await getDocs(q);
  if (snapshot.empty) return;

  lastVisible = snapshot.docs[snapshot.docs.length - 1];

  for (const docSnap of snapshot.docs) {
    const data = docSnap.data();
    const time = data.created?.toDate() ? formatTime(data.created.toDate()) : "just now";
    const item = document.createElement("div");
    item.style.border = "1px solid #ccc";
    item.style.padding = "8px";
    item.style.margin = "10px 0";
    item.innerHTML = `
      <p><strong>${data.name}</strong> <small>(${time})</small></p>
      <p>${data.text}</p>
      <button onclick="likeComment('${docSnap.id}')">üëç ${data.likes}</button>
      <button onclick="dislikeComment('${docSnap.id}')">üëé ${data.dislikes}</button>
      ${currentUser?.uid === OWNER_UID ? `<button onclick="deleteComment('${docSnap.id}')">üóëÔ∏è Delete</button>` : ""}
    `;
    container.appendChild(item);
  }
};

window.onload = () => loadComments();

  </script>
</head>
<body>
  <h2>Comment Section</h2>
  <p id="user">Loading...</p>
  <button onclick="signIn()">Sign in with Google</button><br><br>
  <textarea id="comment" rows="4" cols="50" placeholder="Write a comment..."></textarea><br>
  <button onclick="postComment()">Post Comment</button>
  <h3>All Comments:</h3>
  <div id="comments"></div>
  <button onclick="loadComments()">Load More</button>
</body>
</html>
