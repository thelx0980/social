<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Comments System (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
    <div class="max-w-3xl mx-auto p-6">
        <!-- Auth UI -->
        <div id="auth" class="mb-6">
            <p id="user-info" class="mb-2 text-sm text-gray-700">Checking auth‚Ä¶</p>
            <div class="flex gap-2 flex-wrap">
                <button id="login-main-btn" class="auth-show px-4 py-2 bg-green-600 text-white rounded">Login</button>
                <button id="register-main-btn" class="auth-show px-4 py-2 bg-yellow-600 text-white rounded">Register</button>
                <button id="logout-btn" class="auth-hide hidden px-4 py-2 bg-red-600 text-white rounded">Logout</button>
            </div>
        </div>

        <!-- New Comment -->
        <div class="mb-6">
            <textarea id="new-comment" rows="3" placeholder="Add a public comment..." class="w-full p-3 border rounded"></textarea>
            <button id="post-comment-btn" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded">Post Comment</button>
        </div>

        <!-- Comments -->
        <div id="comments" class="space-y-4"></div>
        <button id="load-more-btn" class="mt-4 px-4 py-2 bg-gray-300 text-gray-700 rounded hidden">
            Load More Comments
        </button>
    </div>

    <!-- Modals omitted for brevity -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth, GoogleAuthProvider, onAuthStateChanged,
            signInWithPopup, signInAnonymously,
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore, collection, doc,
            addDoc, updateDoc, deleteDoc,
            serverTimestamp, query, orderBy,
            limit, startAfter, getDocs,
            arrayUnion, arrayRemove, getDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "...",
            authDomain: "...",
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };
        const OWNER_UID = "LMRHGwdCUeRRJRQnOyPNFwDMtK92";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const gp = new GoogleAuthProvider();

        // Elements
        const loginBtn = document.getElementById("login-main-btn"),
              registerBtn = document.getElementById("register-main-btn"),
              logoutBtn = document.getElementById("logout-btn"),
              userInfo = document.getElementById("user-info"),
              newCommentEl = document.getElementById("new-comment"),
              postCommentBtn = document.getElementById("post-comment-btn"),
              commentsDiv = document.getElementById("comments"),
              loadMoreBtn = document.getElementById("load-more-btn");

        window.closeModal = id => document.getElementById(id).classList.add("hidden");
        const openModal = id => document.getElementById(id).classList.remove("hidden");

        // Auth handlers...
        loginBtn.onclick = () => openModal("login-modal");
        registerBtn.onclick = () => openModal("register-modal");
        logoutBtn.onclick = () => signOut(auth);

        // ... (login/register button callbacks remain same)

        let currentUser = null, lastVisible = null;
        const PAGE_SIZE = 10;

        onAuthStateChanged(auth, user => {
            currentUser = user;
            if (user) {
                userInfo.textContent = `Hello, ${user.displayName || "Guest"}`;
                document.querySelectorAll(".auth-show").forEach(el => el.classList.add("hidden"));
                document.querySelectorAll(".auth-hide").forEach(el => el.classList.remove("hidden"));
            } else {
                userInfo.textContent = "Not signed in";
                document.querySelectorAll(".auth-show").forEach(el => el.classList.remove("hidden"));
                document.querySelectorAll(".auth-hide").forEach(el => el.classList.add("hidden"));
            }
            loadComments(true);
        });

        function timeAgo(ts) {
            const now = Date.now(), secs = Math.floor((now - ts.toMillis()) / 1000);
            if (secs < 60) return `${secs}s ago`;
            const m = Math.floor(secs / 60); if (m < 60) return `${m}m ago`;
            const h = Math.floor(m / 60); if (h < 24) return `${h}h ago`;
            return `${Math.floor(h / 24)}d ago`;
        }

        postCommentBtn.onclick = async () => {
            if (!currentUser) return alert("Please login first");
            const txt = newCommentEl.value.trim();
            if (!txt) return;
            await addDoc(collection(db, "comments"), {
                text: txt,
                uid: currentUser.uid,
                name: currentUser.displayName || "Guest",
                photoURL: currentUser.photoURL || null,
                created: serverTimestamp(),
                edited: false,
                likes: [],
                dislikes: []
            });
            newCommentEl.value = "";
            loadComments(true);
        };

        async function loadComments(reset = false) {
            if (reset) {
                commentsDiv.innerHTML = "";
                lastVisible = null;
            }
            let q = query(collection(db, "comments"), orderBy("created", "desc"), limit(PAGE_SIZE));
            if (lastVisible) {
                q = query(collection(db, "comments"), orderBy("created", "desc"), startAfter(lastVisible), limit(PAGE_SIZE));
            }
            const snap = await getDocs(q);
            if (!snap.empty) {
                lastVisible = snap.docs[snap.docs.length - 1];
                snap.docs.forEach(docSnap => renderComment(docSnap.id, docSnap.data()));
            }
            loadMoreBtn.classList.toggle("hidden", snap.size < PAGE_SIZE);
        }

        loadMoreBtn.onclick = () => loadComments();

        // üî¥ onSnapshot() ‡§™‡•Ç‡§∞‡•Ä ‡§≤‡§æ‡§á‡§® ‡§π‡§ü‡§æ ‡§¶‡•Ä ‡§π‡•à, real-time listener ‡§π‡§ü ‡§ó‡§Ø‡§æ‡•§

        async function loadReplies(parentId, container, reset = false) {
            if (reset) container.innerHTML = "";
            const snap = await getDocs(query(collection(db, "comments", parentId, "replies"), orderBy("created", "asc")));
            const replies = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            replies.slice(0, 5).forEach(r => renderReply(r, container));
            if (replies.length > 5) {
                const btn = document.createElement("button");
                btn.textContent = `Show ${replies.length - 5} more replies`;
                btn.className = "text-sm text-blue-500 ml-6";
                btn.onclick = () => {
                    replies.slice(5).forEach(r => renderReply(r, container));
                    btn.remove();
                };
                container.appendChild(btn);
            }
        }

        function renderReply({ id, name, text, created, photoURL, uid }, container) {
            const isAdmin = uid === OWNER_UID;
            const avatar = photoURL || '/default-avatar.png';
            const el = document.createElement("div");
            el.className = "bg-gray-50 p-2 rounded mb-1 flex items-start gap-2";
            el.innerHTML = `
                <img src="${avatar}" class="w-6 h-6 rounded-full ${isAdmin ? 'ring-2 ring-yellow-400' : ''}" />
                <div class="flex-1">
                    <div class="flex justify-between">
                        <p class="text-sm font-semibold ${isAdmin ? 'text-yellow-600' : ''}">${name}${isAdmin ? ' ‚òÖ' : ''}</p>
                        <p class="text-xs text-gray-500">${created ? timeAgo(created) : ''}</p>
                    </div>
                    <p class="text-sm ml-1">${text}</p>
                </div>`;
            container.appendChild(el);
        }

        function renderComment(id, data) {
            const isOwner = currentUser?.uid === data.uid;
            const isAdmin = currentUser?.uid === OWNER_UID;
            const youLiked = currentUser && data.likes.includes(currentUser.uid);
            const youDisliked = currentUser && data.dislikes.includes(currentUser.uid);
            const avatarURL = data.photoURL || '/default-avatar.png';

            const div = document.createElement("div");
            div.className = `bg-white p-4 rounded shadow-sm ${data.uid === OWNER_UID ? 'border-2 border-yellow-400' : ''}`;
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <img src="${avatarURL}" class="w-8 h-8 rounded-full ${data.uid === OWNER_UID ? 'ring-2 ring-yellow-400' : ''}" />
                        <p class="font-semibold ${data.uid === OWNER_UID ? 'text-yellow-600' : ''}">${data.name}${data.uid === OWNER_UID ? ' ‚òÖ' : ''}</p>
                    </div>
                    <p class="text-xs text-gray-500">${data.created ? timeAgo(data.created) : ''}${data.edited ? ' ‚Ä¢ edited' : ''}</p>
                </div>
                <p class="my-2">${data.text}</p>
                <div class="flex items-center text-sm text-gray-600">
                    <button data-action="like" class="mr-2 ${youLiked ? 'text-blue-600' : ''}">üëç ${data.likes.length}</button>
                    <button data-action="dislike" class="mr-2 ${youDisliked ? 'text-red-600' : ''}">üëé ${data.dislikes.length}</button>
                    <button data-action="reply" class="mr-2">Reply</button>
                    ${isOwner || isAdmin
                        ? `<button data-action="edit" class="mr-2">Edit</button>
                           <button data-action="delete" class="text-red-500">Delete</button>`
                        : ''}
                </div>
                <div class="ml-6 mt-2 reply-form hidden">
                    <textarea rows="2" class="w-full border rounded p-2" placeholder="Write a reply..."></textarea>
                    <button class="mt-1 px-3 py-1 bg-indigo-500 text-white rounded post-reply-btn">Reply</button>
                </div>
                <div class="ml-6 mt-2 replies"></div>
            `;

            // ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§≤‡•ã‡§ï‡§≤ UI ‡§Ö‡§™‡§°‡•á‡§ü, ‡§™‡•Ç‡§∞‡•á ‡§≤‡•ã‡§° ‡§ï‡•Ä ‡§¨‡§ú‡§æ‡§Ø
            div.querySelectorAll("button").forEach(btn => {
                const action = btn.getAttribute('data-action');
                if (action === 'like' || action === 'dislike') {
                    btn.onclick = async (e) => {
                        if (!currentUser) return alert("Login first");
                        const fieldAdd = action === 'like' ? 'likes' : 'dislikes';
                        const fieldRem = action === 'like' ? 'dislikes' : 'likes';
                        const ref = doc(db, "comments", id);
                        const snap = await getDoc(ref);
                        const d = snap.data();

                        // DB ‡§Ö‡§™‡§°‡•á‡§ü
                        if (d[fieldAdd].includes(currentUser.uid)) {
                            await updateDoc(ref, { [fieldAdd]: arrayRemove(currentUser.uid) });
                        } else {
                            if (d[fieldRem].includes(currentUser.uid)) {
                                await updateDoc(ref, { [fieldRem]: arrayRemove(currentUser.uid) });
                            }
                            await updateDoc(ref, { [fieldAdd]: arrayUnion(currentUser.uid) });
                        }

                        // ‡§≤‡•ã‡§ï‡§≤ UI ‡§Ö‡§™‡§°‡•á‡§ü
                        const newCount = (await getDoc(ref)).data()[fieldAdd].length;
                        btn.textContent = `${action === 'like' ? 'üëç' : 'üëé'} ${newCount}`;
                        btn.classList.toggle(action === 'like' ? 'text-blue-600' : 'text-red-600');
                    };
                } else {
                    // reply/edit/delete handlers ‡§™‡§π‡§≤‡•á ‡§ï‡•Ä ‡§§‡§∞‡§π...
                    btn.onclick = e => handleNonLikeActions(action, e, id, data, div);
                }
            });

            // reply rendering ‡§Ü‡§¶‡§ø...
            loadReplies(id, div.querySelector('.replies'), true);
            commentsDiv.appendChild(div);
        }

        // handleNonLikeActions ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§™‡§π‡§≤‡•á ‡§µ‡§æ‡§≤‡§æ reply/edit/delete logic ‡§∞‡§ñ ‡§¶‡•á‡§Ç

    </script>
</body>
</html>
